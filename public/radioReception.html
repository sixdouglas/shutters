<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <meta name="description" content="Baking Bootstrap Snippets with Jade">
        <title>Home Tech</title>
        <link rel="stylesheet" href="/stylesheets/style.css">
    </head>
    <body class="nopadding">
<!-- HTML generated using hilite.me -->
        <div>
            <table>
                <tr>
                    <td class="lineNumbering">
                        <pre style="margin: 0; line-height: 125%">  1
  2
  3
  4
  5
  6
  7
  8
  9
 10
 11
 12
 13
 14
 15
 16
 17
 18
 19
 20
 21
 22
 23
 24
 25
 26
 27
 28
 29
 30
 31
 32
 33
 34
 35
 36
 37
 38
 39
 40
 41
 42
 43
 44
 45
 46
 47
 48
 49
 50
 51
 52
 53
 54
 55
 56
 57
 58
 59
 60
 61
 62
 63
 64
 65
 66
 67
 68
 69
 70
 71
 72
 73
 74
 75
 76
 77
 78
 79
 80
 81
 82
 83
 84
 85
 86
 87
 88
 89
 90
 91
 92
 93
 94
 95
 96
 97
 98
 99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275</pre>
                    </td>
                    <td>
                        <pre style="margin: 0; line-height: 125%"><span style="color: #888888">/*</span>
<span style="color: #888888">Cette page récupere les informations du signal radio recu par le raspberry PI et execute une page PHP</span>
<span style="color: #888888">en lui fournissant tout les paramêtres.</span>

<span style="color: #888888">Vous pouvez compiler cette source via la commande :</span>
<span style="color: #888888">   g++ radioReception.cpp -o radioReception -lwiringPi</span>
<span style="color: #888888">   </span>
<span style="color: #888888">   N&#39;oubliez pas d&#39;installer auparavant la librairie wiring pi ainsi que l&#39;essentiel des paquets pour compiler</span>

<span style="color: #888888">Vous pouvez lancer le programme via la commande :</span>
<span style="color: #888888">   sudo chmod 777 radioReception</span>
<span style="color: #888888">   ./radioReception /var/www/radioReception/radioReception.php  7</span>

<span style="color: #888888">   Les deux parametres de fin étant le chemin vers le PHP a appeller, et le numéro wiringPi du PIN relié au récepteur RF 433 mhz</span>
<span style="color: #888888">   </span>
<span style="color: #888888">@author : Valentin CARRUESCO (idleman@idleman.fr)</span>
<span style="color: #888888">@contributors : Yann PONSARD, Jimmy LALANDE</span>
<span style="color: #888888">@webPage : http://blog.idleman.fr</span>
<span style="color: #888888">@references &amp; Libraries: https://projects.drogon.net/raspberry-pi/wiringpi/, http://playground.arduino.cc/Code/HomeEasy</span>
<span style="color: #888888">@licence : CC by sa (http://creativecommons.org/licenses/by-sa/3.0/fr/)</span>
<span style="color: #888888">RadioPi de Valentin CARRUESCO (Idleman) est mis à disposition selon les termes de la </span>
<span style="color: #888888">licence Creative Commons Attribution - Partage dans les Mêmes Conditions 3.0 France.</span>
<span style="color: #888888">Les autorisations au-delà du champ de cette licence peuvent être obtenues à idleman@idleman.fr.</span>
<span style="color: #888888">*/</span>

<span style="color: #557799">#include &lt;wiringPi.h&gt;</span>
<span style="color: #557799">#include &lt;iostream&gt;</span>
<span style="color: #557799">#include &lt;stdio.h&gt;</span>
<span style="color: #557799">#include &lt;sys/time.h&gt;</span>
<span style="color: #557799">#include &lt;time.h&gt;</span>
<span style="color: #557799">#include &lt;stdlib.h&gt;</span>
<span style="color: #557799">#include &lt;sched.h&gt;</span>
<span style="color: #557799">#include &lt;sstream&gt;</span>

<span style="color: #008800; font-weight: bold">using</span> <span style="color: #008800; font-weight: bold">namespace</span> std;

<span style="color: #888888">//initialisation du pin de reception</span>
<span style="color: #333399; font-weight: bold">int</span> pin;

<span style="color: #888888">//Fonction de log</span>
<span style="color: #333399; font-weight: bold">void</span> <span style="color: #0066BB; font-weight: bold">log</span>(string a){
    <span style="color: #888888">//Décommenter pour avoir les logs</span>
    <span style="color: #888888">//cout &lt;&lt; a &lt;&lt; endl;</span>
}

<span style="color: #888888">//Fonction de conversion long vers string</span>
string <span style="color: #0066BB; font-weight: bold">longToString</span>(<span style="color: #333399; font-weight: bold">long</span> mylong){
    string mystring;
    stringstream mystream;
    mystream <span style="color: #333333">&lt;&lt;</span> mylong;
    <span style="color: #008800; font-weight: bold">return</span> mystream.str();
}

<span style="color: #888888">//Fonction de passage du programme en temps réel (car la reception se joue a la micro seconde près)</span>
<span style="color: #333399; font-weight: bold">void</span> <span style="color: #0066BB; font-weight: bold">scheduler_realtime</span>() {
    <span style="color: #008800; font-weight: bold">struct</span> sched_param p;
    p.__sched_priority <span style="color: #333333">=</span> sched_get_priority_max(SCHED_RR);
    <span style="color: #008800; font-weight: bold">if</span>( sched_setscheduler( <span style="color: #0000DD; font-weight: bold">0</span>, SCHED_RR, <span style="color: #333333">&amp;</span>p ) <span style="color: #333333">==</span> <span style="color: #333333">-</span><span style="color: #0000DD; font-weight: bold">1</span> ) {
        perror(<span style="background-color: #fff0f0">&quot;Failed to switch to realtime scheduler.&quot;</span>);
    }
}

<span style="color: #888888">//Fonction de remise du programme en temps standard</span>
<span style="color: #333399; font-weight: bold">void</span> <span style="color: #0066BB; font-weight: bold">scheduler_standard</span>() {
    <span style="color: #008800; font-weight: bold">struct</span> sched_param p;
    p.__sched_priority <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>;
    <span style="color: #008800; font-weight: bold">if</span>( sched_setscheduler( <span style="color: #0000DD; font-weight: bold">0</span>, SCHED_OTHER, <span style="color: #333333">&amp;</span>p ) <span style="color: #333333">==</span> <span style="color: #333333">-</span><span style="color: #0000DD; font-weight: bold">1</span> ) {
        perror(<span style="background-color: #fff0f0">&quot;Failed to switch to normal scheduler.&quot;</span>);
    }
}

<span style="color: #888888">//Recuperation du temp (en micro secondes) d&#39;une pulsation</span>
<span style="color: #333399; font-weight: bold">int</span> <span style="color: #0066BB; font-weight: bold">pulseIn</span>(<span style="color: #333399; font-weight: bold">int</span> pin, <span style="color: #333399; font-weight: bold">int</span> level, <span style="color: #333399; font-weight: bold">int</span> timeout)
{
    <span style="color: #008800; font-weight: bold">struct</span> timeval tn, t0, t1;
    <span style="color: #333399; font-weight: bold">long</span> micros;
    gettimeofday(<span style="color: #333333">&amp;</span>t0, <span style="color: #007020">NULL</span>);
    micros <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>;
    <span style="color: #008800; font-weight: bold">while</span> (digitalRead(pin) <span style="color: #333333">!=</span> level)
    {
        gettimeofday(<span style="color: #333333">&amp;</span>tn, <span style="color: #007020">NULL</span>);
        <span style="color: #008800; font-weight: bold">if</span> (tn.tv_sec <span style="color: #333333">&gt;</span> t0.tv_sec) {
            micros <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">1000000L</span>; 
        }<span style="color: #008800; font-weight: bold">else</span> {
            micros <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>;
        }
        micros <span style="color: #333333">+=</span> (tn.tv_usec <span style="color: #333333">-</span> t0.tv_usec);
        <span style="color: #008800; font-weight: bold">if</span> (micros <span style="color: #333333">&gt;</span> timeout) {
            <span style="color: #008800; font-weight: bold">return</span> <span style="color: #0000DD; font-weight: bold">0</span>;
        }
    }
    gettimeofday(<span style="color: #333333">&amp;</span>t1, <span style="color: #007020">NULL</span>);
    <span style="color: #008800; font-weight: bold">while</span> (digitalRead(pin) <span style="color: #333333">==</span> level)
    {
        gettimeofday(<span style="color: #333333">&amp;</span>tn, <span style="color: #007020">NULL</span>);
        <span style="color: #008800; font-weight: bold">if</span> (tn.tv_sec <span style="color: #333333">&gt;</span> t0.tv_sec) {
            micros <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">1000000L</span>; 
        }<span style="color: #008800; font-weight: bold">else</span>{
            micros <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>;
        }
        micros <span style="color: #333333">=</span> micros <span style="color: #333333">+</span> (tn.tv_usec <span style="color: #333333">-</span> t0.tv_usec);
        <span style="color: #008800; font-weight: bold">if</span> (micros <span style="color: #333333">&gt;</span> timeout) {
            <span style="color: #008800; font-weight: bold">return</span> <span style="color: #0000DD; font-weight: bold">0</span>;
        }
    }
    <span style="color: #008800; font-weight: bold">if</span> (tn.tv_sec <span style="color: #333333">&gt;</span> t1.tv_sec) {
        micros <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">1000000L</span>;
    } <span style="color: #008800; font-weight: bold">else</span> {
        micros <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>;
    }
    micros <span style="color: #333333">=</span> micros <span style="color: #333333">+</span> (tn.tv_usec <span style="color: #333333">-</span> t1.tv_usec);
    <span style="color: #008800; font-weight: bold">return</span> micros;
}

<span style="color: #888888">//Programme principal</span>
<span style="color: #333399; font-weight: bold">int</span> <span style="color: #0066BB; font-weight: bold">main</span> (<span style="color: #333399; font-weight: bold">int</span> argc, <span style="color: #333399; font-weight: bold">char</span><span style="color: #333333">**</span> argv)
{
    <span style="color: #888888">//On passe en temps réel</span>
    scheduler_realtime();
    
    string command;
    log(<span style="background-color: #fff0f0">&quot;Demarrage du programme&quot;</span>);
    <span style="color: #888888">//on récupere l&#39;argument 1, qui est le numéro de Pin GPIO auquel est connecté le recepteur radio</span>
    pin <span style="color: #333333">=</span> atoi(argv[<span style="color: #0000DD; font-weight: bold">1</span>]);
    <span style="color: #888888">//Si on ne trouve pas la librairie wiringPI, on arrête l&#39;execution</span>
    <span style="color: #008800; font-weight: bold">if</span>(wiringPiSetup() <span style="color: #333333">==</span> <span style="color: #333333">-</span><span style="color: #0000DD; font-weight: bold">1</span>) {
        log(<span style="background-color: #fff0f0">&quot;Librairie Wiring PI introuvable, veuillez lier cette librairie...&quot;</span>);
        <span style="color: #008800; font-weight: bold">return</span> <span style="color: #333333">-</span><span style="color: #0000DD; font-weight: bold">1</span>;
    }<span style="color: #008800; font-weight: bold">else</span>{
        log(<span style="background-color: #fff0f0">&quot;Librairie WiringPI detectee&quot;</span>);
    }
    pinMode(pin, INPUT);
    log(<span style="background-color: #fff0f0">&quot;Pin GPIO configure en entree&quot;</span>);
    log(<span style="background-color: #fff0f0">&quot;Attente d&#39;un signal du transmetteur ...&quot;</span>);
    
    <span style="color: #888888">//On boucle pour ecouter les signaux</span>
    <span style="color: #008800; font-weight: bold">for</span>(;;)
    {
        <span style="color: #333399; font-weight: bold">int</span> i <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>;
        <span style="color: #333399; font-weight: bold">unsigned</span> <span style="color: #333399; font-weight: bold">long</span> t <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>;
        <span style="color: #888888">//avant dernier byte reçu</span>
        <span style="color: #333399; font-weight: bold">int</span> prevBit <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>;
        <span style="color: #888888">//dernier byte reçu</span>
        <span style="color: #333399; font-weight: bold">int</span> bit <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>;
        
        <span style="color: #888888">//mise a zero de l&#39;idenfiant télécommande</span>
        <span style="color: #333399; font-weight: bold">unsigned</span> <span style="color: #333399; font-weight: bold">long</span> sender <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>;
        <span style="color: #888888">//mise a zero du groupe</span>
        <span style="color: #333399; font-weight: bold">bool</span> group <span style="color: #333333">=</span> <span style="color: #007020">false</span>;
        <span style="color: #888888">//mise a zero de l&#39;etat on/off</span>
        <span style="color: #333399; font-weight: bold">bool</span> on <span style="color: #333333">=</span> <span style="color: #007020">false</span>;
        <span style="color: #888888">//mise a zero de l&#39;idenfiant de la rangée de bouton</span>
        <span style="color: #333399; font-weight: bold">unsigned</span> <span style="color: #333399; font-weight: bold">long</span> recipient <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>;
        
        command <span style="color: #333333">=</span> <span style="background-color: #fff0f0">&quot;&quot;</span>;
        t <span style="color: #333333">=</span> pulseIn(pin, LOW, <span style="color: #0000DD; font-weight: bold">1000000</span>);
        
        <span style="color: #888888">// Latch 1:  275us HIGH</span>
        <span style="color: #888888">// Latch 2: 2675us LOW</span>
        
        <span style="color: #888888">// Gap 10 ms between each message</span>
        
        <span style="color: #888888">// 0:  275us HIGH</span>
        <span style="color: #888888">//     275us LOW</span>
        <span style="color: #888888">// 1:  275us HIGH</span>
        <span style="color: #888888">//    1225us LOW</span>
        
        <span style="color: #888888">// bits 0-25 : Group Code</span>
        <span style="color: #888888">// bit 26    : Group Flag</span>
        <span style="color: #888888">// bit 27    : On/Off Flag</span>
        <span style="color: #888888">// bits 28-31: Device Code - 4bit Number</span>
        
        <span style="color: #888888">//Verrou 1</span>
        <span style="color: #008800; font-weight: bold">while</span>(t <span style="color: #333333">&lt;</span> <span style="color: #0000DD; font-weight: bold">9480</span> <span style="color: #333333">||</span> t <span style="color: #333333">&gt;</span> <span style="color: #0000DD; font-weight: bold">10350</span>){
            t <span style="color: #333333">=</span> pulseIn(pin, LOW,<span style="color: #0000DD; font-weight: bold">1000000</span>);
        }
        log(<span style="background-color: #fff0f0">&quot;  t:&quot;</span> <span style="color: #333333">+</span> longToString(t));
        
        log(<span style="background-color: #fff0f0">&quot;Verrou 1 detecte&quot;</span>);
        
        <span style="color: #888888">//Verrou 2</span>
        <span style="color: #008800; font-weight: bold">while</span>(t <span style="color: #333333">&lt;</span> <span style="color: #0000DD; font-weight: bold">2700</span> <span style="color: #333333">||</span> t <span style="color: #333333">&gt;</span> <span style="color: #0000DD; font-weight: bold">2800</span>){
            t <span style="color: #333333">=</span> pulseIn(pin, LOW,<span style="color: #0000DD; font-weight: bold">1000000</span>);
        }
        log(<span style="background-color: #fff0f0">&quot;  t:&quot;</span> <span style="color: #333333">+</span> longToString(t));
        
        log(<span style="background-color: #fff0f0">&quot;Verrou 2 detecte&quot;</span>);
        
        <span style="color: #888888">// données</span>
        <span style="color: #008800; font-weight: bold">while</span>(i <span style="color: #333333">&lt;</span> <span style="color: #0000DD; font-weight: bold">64</span>){
            t <span style="color: #333333">=</span> pulseIn(pin, LOW, <span style="color: #0000DD; font-weight: bold">1000000</span>);
            
            <span style="color: #888888">//Définition du bit (0 ou 1)</span>
            <span style="color: #008800; font-weight: bold">if</span>(t <span style="color: #333333">&gt;</span> <span style="color: #0000DD; font-weight: bold">200</span> <span style="color: #333333">&amp;&amp;</span> t <span style="color: #333333">&lt;</span> <span style="color: #0000DD; font-weight: bold">365</span>){
                bit <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>;
            } <span style="color: #008800; font-weight: bold">else</span> {
                <span style="color: #008800; font-weight: bold">if</span>(t <span style="color: #333333">&gt;</span> <span style="color: #0000DD; font-weight: bold">1000</span> <span style="color: #333333">&amp;&amp;</span> t <span style="color: #333333">&lt;</span> <span style="color: #0000DD; font-weight: bold">1360</span>){
                    bit <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">1</span>;
                } <span style="color: #008800; font-weight: bold">else</span> {
                    <span style="color: #888888">// ni un 0 ni un 1 donc on sort</span>
                    i <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>;
                    <span style="color: #008800; font-weight: bold">break</span>;
                }
            }
            
            <span style="color: #888888">// On regarde les bits impaires</span>
            <span style="color: #888888">// car en encodage Manchester 1 vaut 10, et 0 vaut 01</span>
            <span style="color: #888888">// Le reste (00 ou 11) n&#39;est que parasite</span>
            <span style="color: #008800; font-weight: bold">if</span>(i <span style="color: #333333">%</span> <span style="color: #0000DD; font-weight: bold">2</span> <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">1</span>){
                <span style="color: #008800; font-weight: bold">if</span>((prevBit <span style="color: #333333">^</span> bit) <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">0</span>){
                    <span style="color: #888888">// doit être 01 ou 10, pas 00 ou 11 sinon ou coupe la detection, c&#39;est un parasite</span>
                    i <span style="color: #333333">=</span> <span style="color: #0000DD; font-weight: bold">0</span>;
                    <span style="color: #008800; font-weight: bold">break</span>;
                }

                <span style="color: #008800; font-weight: bold">if</span>(i <span style="color: #333333">&lt;</span> <span style="color: #0000DD; font-weight: bold">53</span>){
                    <span style="color: #888888">// les 26 premiers (0-25) bits sont l&#39;identifiants de la télécommande</span>
                    sender <span style="color: #333333">&lt;&lt;=</span> <span style="color: #0000DD; font-weight: bold">1</span>;
                    sender <span style="color: #333333">|=</span> prevBit;
                } <span style="color: #008800; font-weight: bold">else</span> {
                    <span style="color: #008800; font-weight: bold">if</span>(i <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">53</span>){
                        <span style="color: #888888">// le 26em bit est le bit de groupe</span>
                        group <span style="color: #333333">=</span> prevBit;
                    } <span style="color: #008800; font-weight: bold">else</span> {
                        <span style="color: #008800; font-weight: bold">if</span>(i <span style="color: #333333">==</span> <span style="color: #0000DD; font-weight: bold">55</span>){
                            <span style="color: #888888">// le 27em bit est le bit d&#39;etat (on/off)</span>
                            on <span style="color: #333333">=</span> prevBit;
                        } <span style="color: #008800; font-weight: bold">else</span> {
                            <span style="color: #888888">// les 4 derniers bits (28-32) sont l&#39;identifiant de la rangée de bouton</span>
                            recipient <span style="color: #333333">&lt;&lt;=</span> <span style="color: #0000DD; font-weight: bold">1</span>;
                            recipient <span style="color: #333333">|=</span> prevBit;
                        }
                    }
                }
            }

            prevBit <span style="color: #333333">=</span> bit;
            <span style="color: #333333">++</span>i;
        }
        
        <span style="color: #888888">//Si les données ont bien été détéctées</span>
        <span style="color: #008800; font-weight: bold">if</span>(i <span style="color: #333333">&gt;</span> <span style="color: #0000DD; font-weight: bold">0</span>){
        
            log(<span style="background-color: #fff0f0">&quot;------------------------------&quot;</span>);
            log(<span style="background-color: #fff0f0">&quot;Donnees detectees&quot;</span>);
            cout <span style="color: #333333">&lt;&lt;</span> <span style="background-color: #fff0f0">&quot;sender &quot;</span> <span style="color: #333333">&lt;&lt;</span> sender <span style="color: #333333">&lt;&lt;</span> endl;
            
            command.append(longToString(sender));
            <span style="color: #008800; font-weight: bold">if</span>(group) {
                command.append(<span style="background-color: #fff0f0">&quot; on&quot;</span>);
                cout <span style="color: #333333">&lt;&lt;</span> <span style="background-color: #fff0f0">&quot;group command&quot;</span> <span style="color: #333333">&lt;&lt;</span> endl;
            } <span style="color: #008800; font-weight: bold">else</span> {
                command.append(<span style="background-color: #fff0f0">&quot; off&quot;</span>);
                cout <span style="color: #333333">&lt;&lt;</span> <span style="background-color: #fff0f0">&quot;no group&quot;</span> <span style="color: #333333">&lt;&lt;</span> endl;
            }

            <span style="color: #008800; font-weight: bold">if</span>(on) {
                command.append(<span style="background-color: #fff0f0">&quot; on&quot;</span>);
                cout <span style="color: #333333">&lt;&lt;</span> <span style="background-color: #fff0f0">&quot;on&quot;</span> <span style="color: #333333">&lt;&lt;</span> endl;
            } <span style="color: #008800; font-weight: bold">else</span> {
                command.append(<span style="background-color: #fff0f0">&quot; off&quot;</span>);
                cout <span style="color: #333333">&lt;&lt;</span> <span style="background-color: #fff0f0">&quot;off&quot;</span> <span style="color: #333333">&lt;&lt;</span> endl;
            }
            command.append(<span style="background-color: #fff0f0">&quot; &quot;</span> <span style="color: #333333">+</span> longToString(recipient));
            cout <span style="color: #333333">&lt;&lt;</span> <span style="background-color: #fff0f0">&quot;recipient &quot;</span> <span style="color: #333333">&lt;&lt;</span> recipient <span style="color: #333333">&lt;&lt;</span> endl;
            log(command.c_str());
        } <span style="color: #008800; font-weight: bold">else</span> {
            log(<span style="background-color: #fff0f0">&quot;Aucune donnee...&quot;</span>);
        }
    
        delay(<span style="color: #0000DD; font-weight: bold">3000</span>);
    }
    
    scheduler_standard();
}
</pre>
                    </td>
                </tr>
            </table>
        </div>
    </body>
</html>
